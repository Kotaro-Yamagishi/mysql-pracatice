# MySQLプロファイリングとは

MySQLの性能分析と最適化のための調査

- クエリの実行時間
- リソース使用量
- ボトルネックの特定
- 最適化の提案

## 分析のポイント

1. 段階的な絞り込み

`全体プロファイル → 遅いステップ特定 → 詳細分析 → 原因特定 → 最適化`

2. 複数の観点からの分析

* SHOW PROFILE: 時間分布
* EXPLAIN: 実行計画
* 統計情報: データ量
* インデックス: アクセス方法

3. 継続的な検証

* 最適化前後の比較
* 段階的な改善効果測定
* 本番環境での検証

4. 優先順位の決定

* 最も時間がかかっている処理
* 最も改善効果が高い処理
* 実装コストが低い処理


## プロファイリングの種類

### クエリプロファイリング

実行時の実際の処理のフロー（クエリ発行から結果返却まで。MySQLサーバー内部での処理）

show profileは様々なクエリ指定のようなことができる

```
-- クエリの詳細な実行情報を取得
SET profiling = 1;

-- クエリを実行
SELECT * FROM users WHERE email = 'test@example.com';

-- プロファイリング結果を確認
SHOW PROFILES;
SHOW PROFILE FOR QUERY 1;

Status                     Duration
starting                   0.000023（クエリ開始時間）
checking permissions       0.000005（権限チェック）
Opening tables             0.000012（テーブルオープン）
init                       0.000008（初期化）
System lock                0.000004（システムロック）
optimizing                 0.000015（クエリ最適化）
statistics                 0.000008（統計情報収集）
preparing                  0.000010（クエリ準備）
executing                  0.000025（クエリ実行）
Sending data               0.000045（データ送信）
end                        0.000003（クエリ終了処理）
query end                  0.000002
closing tables             0.000008
freeing items              0.000004
cleaning up                0.000002

```

#### starting

* クエリの構文解析
  * SQLの字句解析
  * 構文解析
  * セマンティック解析
    * テーブル名等の存在確認やデータ型の整合性チェック
* メモリ割り当ての初期化
  * クエリ文字列
    * クエリ文を格納するバッファ
  * 内部構造体
    * QueryContext
    * テーブル情報
    * WHERE条件
  * 一時バッファ
    * 結果セット用のバッファ
    * 中間結果用のバッファ
* 内部データ構造の準備
  * テーブル情報の構造化
    * テーブル名
    * テーブルの物理的な場所（ファイルパス）
  * WHERE条件の解析
  * JOIN情報の整理
* クエリコンテキストの作成
  * クエリの基本情報設定
    * クエリタイプ
    * クエリの優先度
    * 実行モード
  * 実行環境の準備
    * メモリプールの初期化
    * エラーハンドリングの準備
    * ログ出力の準備
  * セキュリティ情報の設定
    * ユーザー権限情報
    * アクセス制御情報
    * 監査ログ情報

#### Checking permissions

* ユーザーのテーブルアクセス権限を確認
* SELECT, INSERT, UPDATE, DELETE権限の検証
* データベースレベルの権限チェック
* カラムレベルの権限チェック（GRANTで設定されている場合）

#### Opening tables

クエリで使用するテーブルのファイルをオープンし、メモリ上にテーブル情報を読み込む処理

* テーブルファイルのオープン
  * .frmファイル（テーブル定義）の読み込み
    * スキーマ情報
  * .ibdファイル（InnoDBデータ）のオープン
    * 実際の行データ
    * インデックス
    * メタデータ
  * ファイルハンドルの取得
    * OSがファイルを識別するための識別子
      * ディスク上のファイルにアクセスするため
  * ファイルロックの取得（必要に応じて）
* テーブルキャッシュからの取得
  * キャッシュヒットの場合は高速処理
  * キャッシュミスの場合はファイルオープン処理
* テーブルメタデータの読み込み
  * テーブル構造情報
  * ストレージエンジン情報
  * 統計情報
* テーブルロックの取得（必要に応じて）
  * 共有ロック
  * 排他ロック
  * メタデータロック

#### init

* クエリ実行エンジンの初期化
* 内部変数の設定
* 一時テーブルの準備（必要に応じて）
* 結果セットの初期化

#### system lock

* テーブルレベルのロック取得
* メタデータロックの取得
* デッドロック検出の準備
* ロック待機の処理

#### optimizing

* クエリオプティマイザによる実行計画の決定
* インデックスの選択
* JOIN順序の決定
* サブクエリの最適化
* 統計情報の使用

#### statistics

* テーブル統計情報の読み込み
* インデックス統計情報の取得
* カーディナリティ情報の収集
* ヒストグラム情報の取得（MySQL 8.0以降）

#### prepaering

* 実行計画の最終調整
* 内部データ構造の準備
* メモリ割り当ての完了
* 実行エンジンの準備完了

#### executing

* データの検索・フィルタリング
* JOIN処理の実行
* 集約処理（GROUP BY, COUNT等）
* ソート処理（ORDER BY）
* サブクエリの実行

#### Sending data

* 結果セットの構築
* クライアントへのデータ送信
* ネットワークバッファへの書き込み
* 結果の整形・フォーマット

#### end

* 実行エンジンの終了
* 一時リソースの解放
* 結果セットの最終化

#### query end

* トランザクション処理の完了
* ログの記録
* 内部状態のクリーンアップ

#### closing tables

* テーブルファイルのクローズ
* テーブルロックの解放
* テーブルキャッシュの更新
* メモリの解放

#### freeing items

* 一時オブジェクトの削除
* メモリプールのクリーンアップ
* 内部バッファの解放

#### cleaning up

* 残存リソースの解放
* 内部状態のリセット
* クエリコンテキストの破棄



### スロークエリログ

```
-- スロークエリログの有効化
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;  -- 1秒以上をスロークエリとして記録

-- スロークエリログの場所確認
SHOW VARIABLES LIKE 'slow_query_log_file';
```

### パフォーマンススキーマ

```
-- パフォーマンススキーマの有効化
UPDATE performance_schema.setup_instruments 
SET ENABLED = 'YES', TIMED = 'YES';

-- イベントの確認
SELECT * FROM performance_schema.events_statements_history_long;
```

### EXPLAIN ANALYZE

```
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';
```
